<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Oficial | Mis Marcas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <h1>EJECUTIVO & √úMID</h1> <div style="cursor: pointer; display: flex; align-items: center; gap: 10px;" onclick="abrirCarrito()">
            <span>üõí</span>
            <span id="contador-carrito">0</span>
        </div>
    </header>

    <main class="container">
        <h2 style="margin-bottom: 20px; font-weight: 300;">Colecci√≥n Disponible</h2>
        <div id="contenedor-productos" class="grid-productos">
            <p style="text-align: center; width: 100%;">Cargando cat√°logo...</p>
        </div>
    </main>

    <div id="modal-carrito" class="modal-overlay">
        <div class="modal-carrito">
            <div class="modal-header">
                <h3>Tu Pedido</h3>
                <button class="btn-cerrar" onclick="cerrarCarrito()">&times;</button>
            </div>
            
            <div id="items-carrito">
                </div>

            <div class="total-compra">
                Total: $<span id="precio-total">0</span>
            </div>

            <button class="btn-whatsapp" onclick="enviarPedido()">
                Completar pedido por WhatsApp
            </button>
        </div>
    </div>

    <script>
        // --- 1. ESTADO DE LA APLICACI√ìN ---
        // Intentamos recuperar el carrito de la memoria local, si no existe, empezamos vac√≠o
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const NUMERO_WHATSAPP = "5491168605033"; // ¬°CAMBIA ESTO POR TU N√öMERO REAL! (Formato: 549 + area + numero)

        // --- 2. L√ìGICA DE CARGA DE PRODUCTOS ---
        async function cargarProductos() {
            try {
                const respuesta = await fetch('/api/productos');
                const productos = await respuesta.json();
                const contenedor = document.getElementById('contenedor-productos');
                contenedor.innerHTML = '';

                if(productos.length === 0) {
                    contenedor.innerHTML = '<p>No hay productos disponibles.</p>';
                    return;
                }

                productos.forEach(prod => {
                    // Creamos un objeto producto seguro para pasar a la funci√≥n
                    // "escape" evita errores con comillas en los nombres
                    const prodString = JSON.stringify(prod).replace(/"/g, '&quot;');
                    
                    const div = document.createElement('div');
                    div.className = 'producto';
                    // Si hay URL, √∫sala tal cual. Si no, pon la imagen por defecto.
                    const imagenSrc = prod.imagen_url ? prod.imagen_url : 'https://via.placeholder.com/300x400?text=Sin+Foto';
                    div.innerHTML = `
                        <img src="${imagenSrc}" alt="${prod.nombre}">
                        <div class="info-producto">
                            <h3>${prod.nombre}</h3>
                            <span class="precio">$${prod.precio}</span>
                            <button onclick="agregarAlCarrito(${prodString})">Agregar al Carrito</button>
                        </div>
                    `;
                    contenedor.appendChild(div);
                });
            } catch (error) {
                console.error("Error de conexi√≥n:", error);
            }
        }

        // --- 3. L√ìGICA DEL CARRITO ---

        function agregarAlCarrito(producto) {
            carrito.push(producto);
            actualizarEstado();
            // Feedback visual simple
            const btn = event.target;
            const textoOriginal = btn.innerText;
            btn.innerText = "¬°Agregado!";
            setTimeout(() => btn.innerText = textoOriginal, 1000);
        }

        function eliminarDelCarrito(index) {
            carrito.splice(index, 1); // Quita 1 elemento en la posici√≥n 'index'
            actualizarEstado();
            renderizarCarrito(); // Redibujar el modal
        }

        function actualizarEstado() {
            // Guardar en memoria del navegador
            localStorage.setItem('carrito', JSON.stringify(carrito));
            // Actualizar numerito del header
            document.getElementById('contador-carrito').innerText = carrito.length;
        }

        // --- 4. INTERFAZ DE USUARIO (UI) ---

        function abrirCarrito() {
            document.getElementById('modal-carrito').style.display = 'flex';
            renderizarCarrito();
        }

        function cerrarCarrito() {
            document.getElementById('modal-carrito').style.display = 'none';
        }

        function renderizarCarrito() {
            const contenedor = document.getElementById('items-carrito');
            const precioTotalEl = document.getElementById('precio-total');
            contenedor.innerHTML = '';
            
            let total = 0;

            if (carrito.length === 0) {
                contenedor.innerHTML = '<p style="text-align:center">Tu carrito est√° vac√≠o.</p>';
            } else {
                carrito.forEach((prod, index) => {
                    total += prod.precio;
                    contenedor.innerHTML += `
                        <div class="item-carrito">
                            <div>
                                <strong>${prod.nombre}</strong><br>
                                <small>$${prod.precio}</small>
                            </div>
                            <button class="btn-eliminar" onclick="eliminarDelCarrito(${index})">Eliminar</button>
                        </div>
                    `;
                });
            }
            
            precioTotalEl.innerText = total;
        }

        // --- 5. CHECKOUT (WHATSAPP) ---
        function enviarPedido() {
            if (carrito.length === 0) return alert("Agrega productos primero.");

            // Armamos el mensaje de texto
            let mensaje = "Hola! Quiero realizar el siguiente pedido:%0A%0A"; // %0A es salto de l√≠nea
            let total = 0;

            carrito.forEach(prod => {
                mensaje += `- ${prod.nombre} ($${prod.precio})%0A`;
                total += prod.precio;
            });

            mensaje += `%0A*Total a pagar: $${total}*`;
            mensaje += "%0A%0AQuedo a la espera para coordinar el pago y env√≠o.";

            // Redirigimos a WhatsApp Web/App
            window.open(`https://wa.me/${NUMERO_WHATSAPP}?text=${mensaje}`, '_blank');
        }

        // Iniciar app
        cargarProductos();
        actualizarEstado(); // Para recuperar el n√∫mero al recargar
    </script>
</body>
</html>